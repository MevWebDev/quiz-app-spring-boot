<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title th:text="'Playing: ' + ${quiz.title}">Quiz</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: #f8f9fa;
      }
      .question-card {
        transition: all 0.3s;
      }
      .question-card:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }
      .timer {
        font-size: 1.5rem;
        font-weight: bold;
      }
      .timer.warning {
        color: #ffc107;
      }
      .timer.danger {
        color: #dc3545;
        animation: pulse 1s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      .answer-option {
        cursor: pointer;
        transition: all 0.2s;
      }
      .answer-option:hover {
        background: #e9ecef;
      }
      .answer-option.selected {
        background: #d1e7dd;
        border-color: #198754;
      }
      .progress-info {
        position: sticky;
        top: 0;
        z-index: 100;
        background: white;
      }
    </style>
  </head>
  <body>
    <!-- Progress Bar -->
    <div class="progress-info py-3 shadow-sm mb-4">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-4">
            <h5 class="mb-0">
              <i class="bi bi-person-circle me-2"></i
              ><span th:text="${nickname}">Player</span>
            </h5>
          </div>
          <div class="col-md-4 text-center">
            <span th:if="${timeLimit != null}" id="timer" class="timer">
              <i class="bi bi-clock me-1"></i>
              <span id="timeRemaining" th:text="${timeLimit}">300</span>s
            </span>
          </div>
          <div class="col-md-4 text-end">
            <span class="badge bg-primary fs-6">
              <span th:text="${#lists.size(questions)}">0</span> Questions
            </span>
          </div>
        </div>
      </div>
    </div>

    <div class="container pb-5">
      <form
        th:action="@{/submit/{id}(id=${quiz.id})}"
        method="post"
        id="quizForm"
      >
        <!-- Questions -->
        <div
          th:each="question, iterStat : ${questions}"
          class="card question-card mb-4 border-0 shadow-sm"
        >
          <div
            class="card-header bg-white d-flex justify-content-between align-items-center"
          >
            <span class="fw-bold">
              Question <span th:text="${iterStat.count}">1</span>
              <span class="badge bg-secondary ms-2" th:text="${question.type}"
                >TYPE</span
              >
            </span>
            <span class="badge bg-primary" th:text="${question.points} + ' pts'"
              >1 pts</span
            >
          </div>
          <div class="card-body">
            <h5 class="card-title mb-4" th:text="${question.text}">
              Question text
            </h5>

            <!-- Single Choice / True-False / Dropdown -->
            <div
              th:if="${question.type == 'SINGLE_CHOICE' or question.type == 'TRUE_FALSE' or question.type == 'DROPDOWN'}"
            >
              <div
                th:each="answer : ${question.answers}"
                class="form-check answer-option p-3 mb-2 border rounded"
              >
                <input
                  class="form-check-input"
                  type="radio"
                  th:name="'answer_' + ${question.id}"
                  th:id="'answer_' + ${answer.id}"
                  th:value="${answer.id}"
                />
                <label
                  class="form-check-label w-100"
                  th:for="'answer_' + ${answer.id}"
                  th:text="${answer.text}"
                  >Answer</label
                >
              </div>
            </div>

            <!-- Multiple Choice -->
            <div th:if="${question.type == 'MULTIPLE_CHOICE'}">
              <p class="text-muted small">
                <i class="bi bi-info-circle me-1"></i>Select all that apply
              </p>
              <div
                th:each="answer : ${question.answers}"
                class="form-check answer-option p-3 mb-2 border rounded"
              >
                <input
                  class="form-check-input multi-choice"
                  type="checkbox"
                  th:data-question="${question.id}"
                  th:id="'answer_' + ${answer.id}"
                  th:value="${answer.id}"
                />
                <label
                  class="form-check-label w-100"
                  th:for="'answer_' + ${answer.id}"
                  th:text="${answer.text}"
                  >Answer</label
                >
              </div>
              <input
                type="hidden"
                th:name="'answer_' + ${question.id}"
                th:id="'multi_' + ${question.id}"
                value=""
              />
            </div>

            <!-- Short Answer / Fill Blank -->
            <div
              th:if="${question.type == 'SHORT_ANSWER' or question.type == 'FILL_BLANK'}"
            >
              <input
                type="text"
                class="form-control"
                th:name="'answer_' + ${question.id}"
                placeholder="Type your answer..."
                required
              />
            </div>

            <!-- Sorting -->
            <div
              th:if="${question.type == 'SORTING'}"
              class="sortable-container"
            >
              <p class="text-muted small">
                <i class="bi bi-info-circle me-1"></i>Drag items to sort them
              </p>
              <div
                th:id="'sortable_' + ${question.id}"
                class="list-group sortable"
              >
                <div
                  th:each="answer : ${question.answers}"
                  class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                  th:data-id="${answer.id}"
                >
                  <span th:text="${answer.text}">Item</span>
                  <i class="bi bi-grip-vertical text-muted"></i>
                </div>
              </div>
              <input
                type="hidden"
                th:name="'answer_' + ${question.id}"
                th:id="'sort_' + ${question.id}"
                value=""
              />
            </div>

            <!-- Matching -->
            <div th:if="${question.type == 'MATCHING'}">
              <p class="text-muted small">
                <i class="bi bi-info-circle me-1"></i>Match items in correct
                order
              </p>
              <div th:each="answer : ${question.answers}" class="mb-2">
                <label th:text="${answer.text}" class="form-label"></label>
                <select
                  class="form-select matching-select"
                  th:data-question="${question.id}"
                >
                  <option value="">Select match...</option>
                  <option
                    th:each="opt : ${question.answers}"
                    th:value="${opt.id}"
                    th:text="${opt.text}"
                  >
                    Option
                  </option>
                </select>
              </div>
              <input
                type="hidden"
                th:name="'answer_' + ${question.id}"
                th:id="'match_' + ${question.id}"
                value=""
              />
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="d-grid gap-2 mt-4">
          <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
            <i class="bi bi-check-circle me-2"></i>Submit Quiz
          </button>
        </div>
      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
      // Timer
      const timeLimit = [[${timeLimit}]];
      if (timeLimit) {
          let remaining = timeLimit;
          const timerEl = document.getElementById('timeRemaining');
          const timerContainer = document.getElementById('timer');

          const interval = setInterval(() => {
              remaining--;
              timerEl.textContent = remaining;

              if (remaining <= 60) timerContainer.classList.add('warning');
              if (remaining <= 10) timerContainer.classList.add('danger');

              if (remaining <= 0) {
                  clearInterval(interval);
                  document.getElementById('quizForm').submit();
              }
          }, 1000);
      }

      // Multiple choice handling
      document.querySelectorAll('.multi-choice').forEach(cb => {
          cb.addEventListener('change', function() {
              const qId = this.dataset.question;
              const checked = document.querySelectorAll(`.multi-choice[data-question="${qId}"]:checked`);
              const values = Array.from(checked).map(c => c.value).join(',');
              document.getElementById('multi_' + qId).value = values;
          });
      });

      // Answer option click handling - select radio/checkbox when clicking the div
      document.querySelectorAll('.answer-option').forEach(opt => {
          opt.addEventListener('click', function(e) {
              // Don't trigger if clicking directly on input or label
              if (e.target.tagName === 'INPUT' || e.target.tagName === 'LABEL') return;

              const input = this.querySelector('input');
              if (input.type === 'radio') {
                  // For radio buttons, select this one
                  input.checked = true;
                  this.closest('.card-body').querySelectorAll('.answer-option').forEach(o => o.classList.remove('selected'));
                  this.classList.add('selected');
              } else if (input.type === 'checkbox') {
                  // For checkboxes, toggle
                  input.checked = !input.checked;
                  this.classList.toggle('selected', input.checked);
                  // Trigger change event for multi-choice handling
                  input.dispatchEvent(new Event('change'));
              }
          });
      });

      // Also add change listener on inputs to update styling
      document.querySelectorAll('.answer-option input').forEach(input => {
          input.addEventListener('change', function() {
              const opt = this.closest('.answer-option');
              if (this.type === 'radio') {
                  opt.closest('.card-body').querySelectorAll('.answer-option').forEach(o => o.classList.remove('selected'));
                  if (this.checked) opt.classList.add('selected');
              } else {
                  opt.classList.toggle('selected', this.checked);
              }
          });
      });

      // Prevent back button
      history.pushState(null, null, location.href);
      window.onpopstate = function() {
          history.go(1);
      };
    </script>
  </body>
</html>
